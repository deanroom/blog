
# 愿景

搭建一套基于云原生的微服务架构平台，能满足现有和将来的业务支撑，横向和纵向解耦业务/技术实现。能够持续集成新功能，能够保证现有业务的稳定迭代。

# 概览

本文主要阐述下图中组件的基本职责,以及如何在整个平台中进行有效的构建和演进.

- **重要实践**
  主要阐述后端研发团队,运维应该具备的文化共识.
- **终端**
  这里的终端指代所有可访问整个平台服务的设备:PC,手机,平板,以及物联网设备.
- **前端**
  针对不同设备对外提供一致服务,浏览器访问的web网站,App访问的WebAPI等均属于前端服务,前端服务主要解决不同设备差异性封装,并聚合后端提供的基础服务.
- **后端**
  所有业务输出输入平台,按照微服务的原则进行边界划分,对外提供完整实现的服务.
  - **业务**
    业务后端根据不同边界进行业务逻辑的实现,地位类似于阿里的中台,不过这是一个跟随时间和业务量逐步演变的过程,最初期主要体现为具有相对清晰边界的不同业务聚合,以构建具体的产品服务为己任.
  - **技术**
    技术后端和业务后端的最主要区别在于技术后端并不直接参与构建产品服务层面的业务,更多的是提供安全性,高并发,高可用的支撑,监控和管理.
  - **基础设施**
    基础设施偏重运行环境,程序构建,部署,通讯,持久化的规范和约束.
![Overview](out/uml/overview/overview.svg)

## 重要实践

### Git使用规范
  
  在开发,部署活动中所有代码,脚本必须在git中托管,不论是自建gitlab,还是平台服务,须严格执行git规范.

- 项目代码务必在git仓库托管
- 提交代码请参考[Angular Commit规范](https://github.com/angular/angular/blob/master/CONTRIBUTING.md)
- 了解并使用Git-Flow [GitFlow参考](https://zhuanlan.zhihu.com/p/66048537)

### 建立适合团队自身的敏捷开发方式

  Wiki[敏捷开发方法](https://zh.wikipedia.org/wiki/%E6%95%8F%E6%8D%B7%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91)
  应该在团队内部建立共识,进行敏捷开发常识普及并集体制定适合本团队的规范方法.

### Linux

  开发团队强调对Linux的使用和依赖,借助Linux的开放性达成研发团队的共同语言符号,对所开发程序的底层操作系统有感性和理性的认知.另外需要了解目前Linux是对docker支持最友好的操作系统.

### Docker

  [Wiki简介](https://en.wikipedia.org/wiki/Docker_(software))

  研发团队须了解目前Docker已经是的大多数软件交付事实上的标准,目前绝大多数软件产品均提供Docker镜像的发布方式,能够极大避免环境配置,版本冲突等问题.尤其是服务端可以快速部署,快速销毁.所以请养成交付标准Docker镜像的习惯.

### CNCF

  [CNCF](https://www.cncf.io)
  以及[CNCF Landscape](https://zhuanlan.zhihu.com/p/68881339)
  
### CI/CD

  CI/CD（持续集成和持续发布）。创建CI/CD环境，从而使源代码上的任意修改，都能够自动通过容器进行编译、测试，并被部署到预生产甚至生产环境中

## 核心业务详解

### 简图

![systemcontext](out/uml/systemcontext/systemcontext.svg)

### 业务后端

根据微服务实践和对核心业务模型的分析,目前按照领域模型对核心业务进行如图拆分:

- 用户服务
  - 提供用户基本信息,
  - 认证,鉴权,可根据实际情况进一步分解为组件或者服务.
- 产品服务
  提供核心课程模型定义,按照领域模型进行建模如实表述业务逻辑,定义授课内容,形式,比如按照课程,课件等概念进行抽象.
  - 课程
  - 习题
  - 考试
  习题考试等内容可以进一步分解为题库中心/服务,均取决于业务要求.
- 订单服务
  - 订单服务
    提供完备和可扩展的订单中心,支持平台内所有订单行为.
  - 财务对账
  - 退费等支撑
  - 支付中心
    初期支付可在本服务实现,但是以组件形式解耦,后续可继续拆分出支付中心用来解耦第三方支付平台的对接.
- 市场服务
  - 定义各种促销活动的业务逻辑.
  - 其他市场策略
- 内容服务
  - 新闻资讯
  - SEO规范
  - 站内广告
  - 其它非产品类内容定义
- 学习服务
  - 提供用户学习活动基础业务逻辑抽象
  - 进行用户产品相关业务耦合.
- 日志
  - 业务日志
  - 行为日志
  - 其它级别日志 
- 数据分析
  - 日志分析
  - 订单分析
  - 用户行为分析
  - 其它需要分析的模型

### 前端服务

  前端业务对基本业务聚合,并输出具备相对完整功能集合用来支撑终端使用,这部分是相对易变的实现,会随着功能定义进行若干功能组合打包.

### 终端API

  解决终端差异性,并提供restAPI接口,作为平台业务和终端链接的最终桥梁,是平台内提供对外服务的公网接口.
  - 接口加解密
  - 终端差异化业务实现.
  这部分内容最易变化,所有业务逻辑的变更均有可能导致此处发生更改.

## 技术后端
  提供非业务但必须实现的服务

  - 公共组件库
    采用DIP原则开发抽象公共组件库,进行抽象定义,所有基础服务的业务逻辑实现只依赖抽象组件定义不依赖具体实现,外部组件的具体实现依赖抽象定义,采用依赖注入/控制翻转原则在程序入口耦合.
  - 服务治理
    微服务部署由于Docker的引入可以最大程度降低环境复杂度的影响,但是由于服务绝对个数增多,带来一系列管理问题,需要一套完备的服务治理策略,从服务发现,注册,治理,监控需要一定的工作来保证.
  - APM
    有效建立分布式调用链追踪,实时查看系统调用性能指标.
  - 可以建立服务异常预警
    通过短信,邮件方式通知运维人员
  - 应用日志
    采集并记录所有应用程序运行日志,这里推荐采用ELK平台,对日志的后续分析检索比较方便
  - API网关
    提供API网关基础组件．

  技术后端的内容会根据程序运行或者新业务的实现逐步更新维护，需要技术团队有一套常规计划来保证技术后端的有效，而且一定要在评估新的业务需求适合把隐性技术需求考虑进去，避免技术债越欠越多．
## 基础设施

### 规划

#### 第一阶段

##### 内部服务

  1. **后台管理**
    - 聚合各个微服务的配置，业务管理

  2. **订单**
    - 支撑订单业务，提供完善的订单管理，统计分析 

  3. **产品服务**
   	- 产品业务实现

  4. **支付**
    - 支付内部接口

##### 公开服务

  1. **登录认证**
  2. **支付**
      - 支付平台回调
  3. App API
  4. 小程序 API

#### 第二阶段

- **登录认证**
- **支付**
- **订单**
- **课程**
- **题库**
- **学习中心**
- **数据分析**
- **App**
- **小程序**
- **服务注册发现健康检查**

#### 第三阶段

- **用户认证**
- **终端认证**
- **支付**
- **订单**
- **课程**
- **题库**
- **学习中心**
- **大数据中心**
- **BI智能分析**
- **AI服务**
- **App多端服务**
- **小程序多端服务**
- **服务注册发现健康检查**

#### 第四阶段

- **业务**
- **大数据**
- **AI**
- **多终端**
- **物联网探索**
- **自建云服务平台**

#### 第...阶段
  - **完备知识平台**